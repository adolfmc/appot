<!DOCTYPE html>
<html lang="en">



<body>
            <!--  主页面 -->
            <div id="id_home" style="display:'' ">
                <div id="wapper" class="wapper">
                    <div class="venue_Top">
                        <div class="venue-Img" id="venueImg">
                            <img src="https://img.dongsport.com/thumbimg/67/34/e6c04099-c04d-4ab5-b8bf-6c62c113d54a_750xx360.jpg" alt="">
                        </div>
                        <div class="venue-Name" id="venue-Name">
                            <input type="text" name="venueId" id="venueId" value="297881" hidden="hidden">
                            
                            <div id='venueName_'>CG</div>
                            <div class="startscore">
                                <div class="star"></div>
                                <div class="score">5分</div>
                            </div>
                        </div>
                    </div>
                    <div class="venue-Address"  style="font-size: 14px;vertical-align:middle;">
                        <div id="venue_address_" style="width: 30rem;text-align: center;margin-right: auto;margin-left: auto;line-height: auto;">ADR</div>
                        <!-- <p style="text-align: center;margin-top: 6px;">青浦区 徐泾镇双联路378号7号楼</br>(近明珠路;微格创意园内)</p>
                        <p style="text-align: center;">tel:021-39889876</p> -->
                    </div>
                </div>
                
                <div class="v-contents">
                    <div class="venues_Tab" id="venues_Tab" style="width:100%;">
                        <div style="white-space: nowrap;overflow-x: auto;">
                            <span onclick="sportType(this,'288322')" id="288322" value="288322" class="cur">羽毛球
                            </span>
                        </div>
                        <div class="move_bar" style="width: 86px; center: 0px;"></div>
                    </div>
                    <div>

                    </div>
                    <!-- 首页 日历-->
                    <div id='calendar'></div>
                </div>
            </div>


            <!--  选择商品 -->
            <div id="id_product" style="display:none ; padding-bottom:550px;">
                <!-- <div class="week">
                    <input type="hidden" name="venueId" id="venueId" value="297881">
                    <input type="hidden" name="sportType" id="sportType" value="0L20">
                    <input type="hidden" name="venueName" id="venueName" value="DC羽毛球馆(YONEX徐泾馆）">
                    <input type="hidden" name="siteId" id="siteId" value="288322">
                    <input type="hidden" name="productId" id="productId" value="10172486">
                    <input type="hidden" name="isHalf" id="isHalf" value="0">

                    <ul id="week">
                    </ul>

                </div> -->

                <div class="seletimes_top" id="seletimes2">
                    <div id="siteItem2" style="width: 10000px;">
                    </div>
                </div>

                <div class="spinner" id="spinnerid" style="display:none;">
                    <div>
                        <p class="bounce1"></p>
                        <p class="bounce2"></p>
                        <p class="bounce3"></p>
                    </div>
                </div>
                <div class="selectday">
                    <div class="seletimes" id="seletimes">
                        <div style="width: 10000px; padding-left: 62px;" id="siteItem">
                        </div>
                    </div>
                    <div class="dialog" data-role="dialog" id="demoDialog1">
                        <!-- 弹窗日历-->
                        <div id='calendar2' class="dialog-content" style="height:320px;width:100%;overflow:scroll;">
                        </div>
                        <div class="dialog-actions" style="display: none;">
                            <button class="button js-dialog-close">Disagree</button>
                        </div>
                    </div>
                    <div class="selectnom">
                    </div>
                </div>
                <div class="venue_Bottom">
                    <div class="signal">
                        <div class="signal_Img" id="signal_Img">
                            <span>
                                <div class="wodeyuding"></div>
                                <p>已选择</p>
                            </span>
                            <span>
                                <div class="keyiding"></div>
                                <p>可预订</p>
                            </span>
                            <span>
                                <div class="yiyuding"></div>
                                <p>已预订</p>
                            </span>
                            <span>
                                <div class="yishouwan"></div>
                                <p>已售完</p>
                            </span>
                        </div>
                        <div class="signal_venues" style="display: none;">
                            <div id="haveChoose"></div>
                        </div>
                    </div>
                    <div class="pay_Btn">
                        <div class="toDo_pay" style="background: rgb(204, 204, 204);">确定</div>
                    </div>
                </div>
            </div>


            <!--  提交订单 -->
            <div id="id_show_order" style="display:none">
                <div class="order_name_site">
                    <span>场馆</span>
                    <div class="order_venue" id='order_venue_name_'>CG</div>
                </div>
                <div class="order_name_site">
                    <span>预订场次</span>
                    <ul id="order_venue_list"></ul>
                </div>

                <div class="order_Fill">
                    <div class="order_name_site">
                        <span>手机号</span>
                        <div class="order_venue">
                            <input type="tel" name="tel" id="tel" value="" style="border: 0px;box-shadow:none"placeholder="请输入手机号" />
                        </div>
                    </div>
                </div>
                <div class="pay_Btn marTop30">
                    <a href="javascript:void(0);" onclick="to_pay_order()" class="toDo_sub">提交订单</a>
                </div>
                <div style="height:400px;background: #fff!important">&nbsp;</div>
                <input type="hidden" name="amount_" id="amount_" value="">
                <input type="hidden" name="choose_date" id="choose_date" value="">
                <input type="hidden" name="venue_name" id="venue_name" value="">


                <input type="hidden" name="siteNos" id="siteNos" value="">
                <input type="hidden" name="stimes" id="stimes" value="">
                <input type="hidden" name="etimes" id="etimes" value="">
                <input type="hidden" name="prices" id="prices" value="">
                <input type="hidden" name="siteNames" id="siteNames" value="">
            </div>


            <!--  订单支付 -->
            <div id="id_pay_order" style="display:none">
                <form method="post">
                    <input type="hidden" name="orderId" id="orderId" value="">
                    <input type="hidden" name="venueId" value="297881">
                    <input type="hidden" name="orderMoney" id="orderMoney" value="75.0">
                    <input type="hidden" name="createDate" id="createDate" value="2020-09-30 13:21:00">
                    <input type="hidden" name="payType">


                    <div id="wapper">
                        <div class="pay_Times">
                            <div class="pay_Times_title">支付剩余时间</div>
                            <div>
                                <span id="minute_show_s">0</span>
                                <span id="minute_show_g">9</span>
                                :
                                <span id="second_show_s">3</span>
                                <span id="second_show_g">4</span>

                            </div>
                           
                        </div>
                        <div class="pay_order_detail">
                            <span class="order-venue-Img"><img
                                    src="https://img.dongsport.com/thumbimg/90/40/18e0a9f9-81d3-45e9-83c6-a7706b6408ec_750xx360.jpg"
                                    alt=""></span>
                            <div class="">
                                <p class="order-venue-i"><span id ="span_amount_">￥75.0</span></p>
                                <p class="order-venue-n"><span>DC羽毛球馆(YONEX徐泾馆）</span></p>
                            </div>
                        </div>
                        <div class=""><img src="" alt=""></div>
                        
                        <div class="paytarget">
                            <ul id="payType">
                                <li id="wx"><i class="weixinzhifu"></i>
                                    <p class="f16">微信支付</p>
                                    <p class="f12">推荐有微信账号的用户使用</p>
                                    <em id="sel_0" data-type="wx"></em>
                                </li>
                            </ul>
                        </div>
                        <div class="pay_Btn marTop30">
                            <span id="confrom_amount_"  class="toDo_sub" style="cursor: pointer" onclick="pay_order()">确认支付75.0元</span>
                        </div>
                        <div style="height:400px;background: #fff!important">&nbsp;</div>
                    </div>
                </form>

            </div>

            <!--  订单记录 -->
            <div id="id_pay_list" style="display:none">
                <div>
                    <div class="vlistnav">
                        <div class="cat fix order-status">
                            <a name='order_type' id='order_dzf' href="javascript:order_list('order_dzf');" >待支付</a>
                            <a name='order_type' id='order_dxf' href="javascript:order_list('order_dxf');" >待消费</a>
                            <a name='order_type' id='order_ywc' href="javascript:order_list('order_ywc');" >已完成</a>
                            <a name='order_type' id='order_all' href="javascript:order_list('order_all');" class="cur">全部订单</a>
                        </div>
                    </div>
                    <div class="list">
                        <ul id="order_list_ul_id">
                        </ul>
                    </div>

                    <div style="height:400px;background: #fff!important">&nbsp;</div>
                </div>

            </div>
            <!--  内容 END  -->
            <div id="id_order_details" style="display:none">
            </div>



    <!-- Metro 4 -->
    <script>
        $(function () {
            //0 加载场地信息
            get_venue()

            //1 加载日历 (首页日历 & 商品页 弹窗日历)
            get_calendar('calendar');
            //2 进入页面要求 获取微信用户信息
            invate_wechat_user();

            //3 判断进入隐藏页面
            var whichPage=getUrlParam('whichPage');
            if(whichPage == 'ck_show_order'){
                ck_show_order();
            }else if(whichPage == 'order_list'){
                order_list('order_all');
            }
            //4设置默认支付方式
            $(this).find("em").addClass("onsel")
            $(this).siblings().find("em").removeClass("onsel")
        });

        function get_venue(){
            $.ajax({type : "POST", url : base_url+"/getVenueById?id=297881",
                success : function(result) {
                    $('#venueName_').html(result.data.venueName);
                    
                    $('#venue_address_').html(result.data.addres).append(' ;tel:').append(result.data.tel);
                }
            });
        }

        function invate_wechat_user(){
            // 本地开发 设置默认值
            storage.headimgurl='https://thirdwx.qlogo.cn/mmopen/vi_32/Q0j4TwGTfTKYPpOWCGE1Mib6CcLpt7qaKBdbooPcicBxSTbNric5O9Nibticx8XibgwkrXlwtPGv7icwSf2GH95sG5KibA/132';
            storage.openId='o21Tg5gcRWoqpNLzPmRZWU2buwvM';
            var cook_headimgurl = storage['headimgurl'];

            if(cook_headimgurl==null ||cook_headimgurl=='' || cook_headimgurl =="undefined"){
                var redirect_getUser_URL = base_url + '/wxpay/getWechatUser.do'
                var wxUrl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx98188fbf500bdf33&redirect_uri=" + encodeURIComponent(redirect_getUser_URL) + "&response_type=code&scope=snsapi_userinfo#wechat_redirect";
                // alert("微信："+wxUrl);
                window.location.href = wxUrl;

                var headimgurl=getUrlParam('headimgurl');
                var openid=getUrlParam('openid');
                var nickname=getUrlParam('nickname');
                storage.headimgurl=headimgurl;
                storage.openid=openid;
                storage.nickname=nickname;
                cook_headimgurl = headimgurl;
            }
            
            //设置头像
            $('.avatar >img')[0].src = cook_headimgurl
        }

        // 主页面板
        function ck_home() {
            $('#id_home').css('display', '');
            $('#id_product').css('display', 'none');
            $('#id_show_order').css('display', 'none');
            $('#id_pay_order').css('display', 'none');
            $('#id_pay_list').css('display', 'none');
            $('#id_order_details').css('display', 'none');
            $("#span_pid").html('首页')
        }

        // 侧面进入 > 选择预定商品
        function ck_product() {
            $('#id_home').css('display','none');
            $('#id_product').css('display','');
            $('#id_show_order').css('display','none');
            $('#id_pay_order').css('display','none');
            $('#id_pay_list').css('display','none');
            $('#id_order_details').css('display', 'none');
            $("#span_pid").html('预约')
            var datee = (new Date()).Format("yyyy-MM-dd") ;
            ck_go_product(datee) ;
        }

        // 首页进入 > 选择预定商品
        function ck_go_product(datee) {
            $('#id_home').css('display', 'none');
            $('#id_product').css('display', '');
            $('#id_show_order').css('display', 'none');
            $('#id_pay_order').css('display', 'none');
            $('#id_pay_list').css('display', 'none');
            $('#id_order_details').css('display', 'none');
            $("#span_pid").html('预约')
            $('#choose_date').val(datee);

            // //1 调整 产品页头部日期 TODO
            $.ajax({type : "POST",contentType: "text/html; charset=utf-8", url : base_url+"/get7Days?datee="+datee,
                success : function(result) {
                    var li_str=""
                    for(var i=0;i<result.length;i++){
                        //判断字体CSS样式
                        var font_class_=""
                        if(datee==result[i][0]){
                            font_class_="cur"
                        }

                        var dd = result[i][0].split('-')
                        dd = dd[1]+'/'+dd[2]
                        li_str=li_str
                        +"<dl class=\""+font_class_+"\" onclick=\"timeChoose(this,'"+result[i][0]+"')\" time=\""+result[i][0]+"\"> <dt>"
                        +   "周"+result[i][1]+"<br>"+dd+""
                        +"</dl></dl>"
                    }

                    $("#siteItem2").empty();
                    $('#siteItem2').append(li_str);

                    // 请求指定日期数据
                    var index = 0;
                    var dls = $('#siteItem2 >dl') ;
                    for(var i=0 ;i<dls.length;i++){
                        if(dls[i].className =='cur'){
                            timeChoose(dls[i],datee)
                            index = i ;
                        }
                    }

                    // 滚动到指定日期位置
                    scrollX(index)

                }
            });

            //2 实时爬取 目标网站真实数据


        }


        // 选择预定商品
        function ck_show_order() {
            $('#id_home').css('display', 'none');
            $('#id_product').css('display', 'none');
            $('#id_show_order').css('display', '');
            $('#id_pay_order').css('display', 'none');
            $('#id_pay_list').css('display', 'none');
            $("#span_pid").html('提交订单')
            $('#id_order_details').css('display', 'none');
            $('#tel').val( storage['mobile'] );
            $('#order_venue_name_').html(  $('#venueName_').html() )
        }



        // 提交交易订单
        function to_pay_order(){
            var venueId=$("#venueId").val();
            var sportType=$("#sportType").val();
            var siteId=$("#siteId").val();
            var productId=$("#productId").val();
            var ishalf=$("#isHalf").val();


            $.ajax({
                type : "POST"
                ,data:{
                    siteNo:$('#siteNos').val(),
                    stime:$('#stimes').val(),
                    etime:$('#etimes').val(),
                    price:$('#prices').val(),
                    siteName:$('#siteNames').val(),
                    time:time,
                    venueId:venueId,
                    sportType:sportType,
                    siteId:siteId,
                    productId:productId,
                    isHalf:ishalf,
                    openId:storage['openId'],
                    mobile:storage['mobile']
                    }
                ,url:base_url+"/sendOrder"
                ,success:function(result) {
                    $('#createDate').val(  formatDate(result.data.createDate)  );
                    $('#id_home').css('display','none');
                    $('#id_product').css('display','none');
                    $('#id_show_order').css('display','none');
                    $('#id_pay_order').css('display','');
                    $('#id_pay_list').css('display','none');
                    $("#span_pid").html('支付订单');
                    $('#id_order_details').css('display', 'none');
                    $('#orderId').val(result.data.id);
                    timer();
                }
            });
        }

        // 支付订单
        function pay_order(order_id) {
            if(order_id==null || order_id=='null' || order_id==undefined){
                order_id = $('#orderId').val();
            }
            var redirect_url = base_url + "/wxpay/pay.do?order_id="+order_id;
            //alert(redirect_url);
            var wxUrl = "https://open.weixin.qq.com/connect/oauth2/authorize?appid=wx98188fbf500bdf33&redirect_uri=" + encodeURIComponent(redirect_url) + "&response_type=code&scope=snsapi_base#wechat_redirect";
            // alert("微信："+wxUrl);
            window.location.href = wxUrl;
            $('#id_home').css('display', 'none');
            $('#id_product').css('display', 'none');
            $('#id_show_order').css('display', 'none');
            $('#id_pay_order').css('display', 'none');
            $('#id_pay_list').css('display', '');
            $('#id_order_details').css('display', 'none');
            $("#span_pid").html('订单记录')
        }

        //订单记录
        function order_list(order_type) {
            var status_='0,2,4';
            $("a[name='order_type']").each(function(){
                $(this).removeAttr("class");
            });

            $('#'+order_type).addClass("cur");
            if(order_type=='order_all'){
                status_='0,2,4';
            }else if(order_type=='order_dxf'){
                status_='2';
            }else if(order_type=='order_dzf'){
                status_='0';
            }else if(order_type=='order_ywc'){
                status_='4';
            }


            console.log(order_type);

            $.ajax({
                type : "POST"
                ,data:{
                    openid:storage['openId'],
                    status:status_
                    }
                ,url:base_url+"/getOrdersByOpenid"
                ,success:function(result) {
                    $('#id_home').css('display', 'none');
                    $('#id_product').css('display', 'none');
                    $('#id_show_order').css('display', 'none');
                    $('#id_pay_order').css('display', 'none');
                    $('#id_pay_list').css('display', '');
                    $('#id_order_details').css('display', 'none');
                    $("#span_pid").html('订单记录')
                    var orders = result.data;
                    if(orders==null ){
                        return ;
                    }
                    var li_str = '';
                    for(var i=0;i<orders.length;i++){
                        var order = orders[i];
                        li_str=li_str+'<li>';
                        li_str=li_str+'        <em>';
                        li_str=li_str+'            <div class="venueImg">';
                        li_str=li_str+'               <a href=javascript:show_order_details("'+order.id+'")><img src="https://img.dongsport.com/thumbimg/90/40/18e0a9f9-81d3-45e9-83c6-a7706b6408ec_750xx360.jpg"></a>';
                        li_str=li_str+'            </div>';
                        li_str=li_str+'            <div class="order-detail">';
                        li_str=li_str+'                <div class="order-name">';
                        li_str=li_str+'                    <a href=javascript:show_order_details("'+order.id+'")> DC 羽毛球徐泾馆预订</a>';
                        li_str=li_str+'                </div>';
                        li_str=li_str+'                <div class="order-num">数量：'+order.numbers+'</div>';
                        li_str=li_str+'                <div class="order-pro">总价：'+order.totalAmount+'.0</div>';
                        li_str=li_str+'            </div>';
                        li_str=li_str+'            <div class="order-status-o">';

                            //待支付
                        if(order.status=='0'){
                            li_str=li_str+'                <div class="daizhifu">待支付</div>';
                            li_str=li_str+'                <div class="order-dai-pay"><a href=javascript:pay_order("'+order.id+'")>支付</a></div>';
                            //待消费
                        }else if(order.status=='2'){
                            li_str=li_str+'                <div class="daizhifu">待消费</div>';
                            // li_str=li_str+'                    <a href=javascript:show_order_details("'+order.id+'")>待消费</a></div>';

                            //支付失败
                        }else if(order.status=='3'){
                            li_str=li_str+'                <div class="daizhifu">支付失败</div>';
                            // li_str=li_str+'                    <a href=javascript:show_order_details("'+order.id+'")>支付失败</a></div>';
                            //已结束
                        }else if(order.status=='4'){
                            li_str=li_str+'                <div class="yiwancheng">已结束</div>';
                            // li_str=li_str+'                    <a href=javascript:show_order_details("'+order.id+'")>已结束</a></div>';
                        }


                        li_str=li_str+'            </div>';
                        li_str=li_str+'        </em>';
                        li_str=li_str+'</li>';
                    }
                    $("#order_list_ul_id").html(li_str) ;
                }
            });


            
        }

        // 订单明细
        function show_order_details(orderid) {
            var div_str = '';
            $.ajax({
                type : "POST"
                ,data:{
                    order_id:orderid
                    }
                ,url:base_url+"/getOrderDetailsByOrderId"
                ,success:function(result) {

                    var order = result.data.order;
                    var orderDetails = result.data.orderDetails;
                    if(order == null ) {
                        return ;
                    } ;

                    div_str = div_str + '<div class="myOrder-venue-infor">';
                    div_str = div_str + '<ul>';
                    div_str = div_str + '        <li><span>订单信息</span></li>';
                    div_str = div_str + '        <li><span>商户：</span>DC羽毛球馆(YONEX徐泾馆）</li>';
                    div_str = div_str + '        <li><span>产品：</span>DC羽毛球馆(YONEX徐泾馆）</li>';
                    div_str = div_str + '                <li><span>单价：</span>'+order.price+'.0</li>';
                    div_str = div_str + '        <li><span>数量：</span>'+order.numbers+'</li>';
                    div_str = div_str + '                <li><span>总价：</span><font color="#fd2b29">￥'+order.totalAmount+'.0</font></li>';
                    div_str = div_str + '    </ul>';
                    div_str = div_str + '</div>';
                    div_str = div_str + '<div class="myOrder-venue-infor">';
                    div_str = div_str + '    <ul>';
                    div_str = div_str + '        <li><span>订单号：</span>'+order.id+'</li>';
                    div_str = div_str + '        <li><span>下单时间：</span>'+formatDate(order.createDate)+'</li>';
                    div_str = div_str + '        <li><span>订单状态：</span>';
                    div_str = div_str + '            <span>';
                    div_str = div_str + '            待支付';
                    div_str = div_str + '            </span>';
                    div_str = div_str + '        </li>';
                    div_str = div_str + '       <li>';
                    div_str = div_str + '           <span>订单明细</span><br>';

                    for(var i=0;i<orderDetails.length;i++){
                        var appotDate = orderDetails[i].appotDate;
                        var appotDate_mm = appotDate.substring(5,7);
                        var appotDate_dd = appotDate.substring(8,11);
                            appotDate = appotDate_mm+'月'+appotDate_dd+'日';
                        div_str = div_str + '       <span>'+orderDetails[i].siteName+' '+appotDate+'  '+orderDetails[i].stime+'-'+orderDetails[i].etime+'  '+orderDetails[i].sitePrice+'元</span><br>';
                    }
                    div_str = div_str + '        </li>';
                    div_str = div_str + '    </ul>';
                    div_str = div_str + '</div>';

                    div_str = div_str + '<form action="/app/order/pay" method="post">';
                    div_str = div_str + '    <input type="hidden" name="orderId" value="'+order.id+'">';
                    div_str = div_str + '    <input type="hidden" name="picurl" value="https://img.dongsport.com/thumbimg/90/40/18e0a9f9-81d3-45e9-83c6-a7706b6408ec_750xx360.jpg">';
                    div_str = div_str + '    <input type="hidden" name="venuname" value="DC羽毛球馆(YONEX徐泾馆）">';
                    div_str = div_str + '    <a href=javascript:pay_order("'+order.id+'") class="toDo_sub">确认支付'+order.totalAmount+'.0元</a>';
                    div_str = div_str + '</form>';
 


                    $('#id_home').css('display', 'none');
                    $('#id_product').css('display', 'none');
                    $('#id_show_order').css('display', 'none');
                    $('#id_pay_order').css('display', 'none');
                    $('#id_pay_list').css('display', 'none');
                    $('#id_order_details').css('display', '');
                    $('#id_order_details').empty();
                    $('#id_order_details').append(div_str);
                }
            });


            
        }



        //支付类型选择
        $("#payType").on("click","li",function(){
            $("input[name='payType']").val($(this).attr("id"));
            if($(this).find("em").hasClass("onsel")){
                $(this).find("em").removeClass("onsel")
                $("input[name='payType']").val("");
            }
            else{
                $(this).find("em").addClass("onsel")
                $(this).siblings().find("em").removeClass("onsel")
            }
        });

        function timer() {
            var createDate=$("#createDate").val();
            // 准备
            var countdownMinute = 10;//10分钟倒计时
            var startTimes = new Date(createDate.replace(/-/g,"/"));//开始时间 new Date('2016-11-16 15:21');
            var endTimes = new Date(startTimes.setMinutes(startTimes.getMinutes()+countdownMinute));//结束时间
            var curTimes = new Date();//当前时间
            var surplusTimes = endTimes.getTime()/1000 - curTimes.getTime()/1000;//结束毫秒-开始毫秒=剩余倒计时间
        
            // 进入倒计时
            countdowns = window.setInterval(function(){
                surplusTimes--;
                var minu = Math.floor(surplusTimes/60);
                var secd = Math.round(surplusTimes%60);
                // console.log(minu+':'+secd);
                if(minu<10){
                    $('#minute_show_s').html('0');
                    $('#minute_show_g').html(minu);
                    $('#second_show_s').html(parseInt(secd/10));
                    $('#second_show_g').html(secd%10);
                }else{
                    $('#minute_show_s').html('1');
                    $('#minute_show_g').html('0');
                    $('#second_show_s').html('0');
                    $('#second_show_g').html('0');
                }
                if(surplusTimes<=0){
                    console.log('时间到！');
                    //window.location="/app/order/myorder.action?venueId="+$("input[name='venueId']").val();
                    //clearInterval(countdowns);
                }
            },1000);
        }


    </script>
</body>

</html>
